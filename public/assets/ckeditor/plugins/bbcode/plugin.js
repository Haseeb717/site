/*
 Copyright (c) 2003-2015, CKSource - Frederico Knabben. All rights reserved.
 For licensing, see LICENSE.md or http://ckeditor.com/license
*/
!function(){CKEDITOR.on("dialogDefinition",function(e){var t;t=e.data.name,e=e.data.definition,"link"==t?(e.removeContents("target"),e.removeContents("upload"),e.removeContents("advanced"),t=e.getContents("info"),t.remove("emailSubject"),t.remove("emailBody")):"image"==t&&(e.removeContents("advanced"),t=e.getContents("Link"),t.remove("cmbTarget"),t=e.getContents("info"),t.remove("txtAlt"),t.remove("basic"))});var e={b:"strong",u:"u",i:"em",color:"span",size:"span",quote:"blockquote",code:"code",url:"a",email:"span",img:"span","*":"li",list:"ol"},t={strong:"b",b:"b",u:"u",em:"i",i:"i",code:"code",li:"*"},n={strong:"b",em:"i",u:"u",li:"*",ul:"list",ol:"list",code:"code",a:"link",img:"img",blockquote:"quote"},i={color:"color",size:"font-size"},r={url:"href",email:"mailhref",quote:"cite",list:"listType"},s=CKEDITOR.dtd,a=CKEDITOR.tools.extend({table:1},s.$block,s.$listItem,s.$tableContent,s.$list),l=/\s*(?:;\s*|$)/,o={smiley:":)",sad:":(",wink:";)",laugh:":D",cheeky:":P",blush:":*)",surprise:":-o",indecision:":|",angry:">:(",angel:"o:)",cool:"8-)",devil:">:-)",crying:";(",kiss:":-*"},u={},c=[],h;for(h in o)u[o[h]]=h,c.push(o[h].replace(/\(|\)|\:|\/|\*|\-|\|/g,function(e){return"\\"+e}));var c=RegExp(c.join("|"),"g"),f=function(){var e=[],t={nbsp:"\xa0",shy:"\xad"},n;for(n in t)e.push(n);return e=RegExp("&("+e.join("|")+");","g"),function(n){return n.replace(e,function(e,n){return t[n]})}}();CKEDITOR.BBCodeParser=function(){this._={bbcPartsRegex:/(?:\[([^\/\]=]*?)(?:=([^\]]*?))?\])|(?:\[\/([a-z]{1,16})\])/gi}},CKEDITOR.BBCodeParser.prototype={parse:function(t){for(var n,s,a=0;n=this._.bbcPartsRegex.exec(t);)if(s=n.index,s>a&&this.onText(t.substring(a,s),1),a=this._.bbcPartsRegex.lastIndex,(s=(n[1]||n[3]||"").toLowerCase())&&!e[s])this.onText(n[0]);else if(n[1]){var o=e[s],u={},c={};if(n=n[2])if("list"==s&&(isNaN(n)?/^[a-z]+$/.test(n)?n="lower-alpha":/^[A-Z]+$/.test(n)&&(n="upper-alpha"):n="decimal"),i[s]){"size"==s&&(n+="%"),c[i[s]]=n,n=u;var h="",f=void 0;for(f in c)var d=(f+":"+c[f]).replace(l,";"),h=h+d;n.style=h}else r[s]&&(u[r[s]]=CKEDITOR.tools.htmlDecode(n));"email"!=s&&"img"!=s||(u.bbcode=s),this.onTagOpen(o,u,CKEDITOR.dtd.$empty[o])}else n[3]&&this.onTagClose(e[s]);t.length>a&&this.onText(t.substring(a,t.length),1)}},CKEDITOR.htmlParser.fragment.fromBBCode=function(e){function t(e){if(0<o.length)for(var t=0;t<o.length;t++){var n=o[t],i=n.name,r=CKEDITOR.dtd[i],s=f.name&&CKEDITOR.dtd[f.name];s&&!s[i]||e&&r&&!r[e]&&CKEDITOR.dtd[e]||(n=n.clone(),n.parent=f,f=n,o.splice(t,1),t--)}}function i(e,t){var i=f.children.length,r=0<i&&f.children[i-1],i=!r&&d.getRule(n[f.name],"breakAfterOpen"),r=r&&r.type==CKEDITOR.NODE_ELEMENT&&d.getRule(n[r.name],"breakAfterClose"),s=e&&d.getRule(n[e],t?"breakBeforeClose":"breakBeforeOpen");h&&(i||r||s)&&h--,h&&e in a&&h++;for(;h&&h--;)f.children.push(new CKEDITOR.htmlParser.element("br"))}function r(e,t){i(e.name,1);var t=t||f||l,n=t.children.length;e.previous=0<n&&t.children[n-1]||null,e.parent=t,t.children.push(e),e.returnPoint&&(f=e.returnPoint,delete e.returnPoint)}var s=new CKEDITOR.BBCodeParser,l=new CKEDITOR.htmlParser.fragment,o=[],h=0,f=l,m;s.onTagOpen=function(e,n){var a=new CKEDITOR.htmlParser.element(e,n);if(CKEDITOR.dtd.$removeEmpty[e])o.push(a);else{var l=f.name,u=l&&(CKEDITOR.dtd[l]||(f._.isBlockLike?CKEDITOR.dtd.div:CKEDITOR.dtd.span));if(u&&!u[e]){var u=!1,c;if(e==l?r(f,f.parent):(e in CKEDITOR.dtd.$listItem?(s.onTagOpen("ul",{}),c=f):(r(f,f.parent),o.unshift(f)),u=!0),f=c||(f.returnPoint||f.parent),u)return void s.onTagOpen.apply(this,arguments)}t(e),i(e),a.parent=f,a.returnPoint=m,m=0,a.isEmpty?r(a):f=a}},s.onTagClose=function(e){for(var t=o.length-1;0<=t;t--)if(e==o[t].name)return void o.splice(t,1);for(var n=[],i=[],s=f;s.type&&s.name!=e;)s._.isBlockLike||i.unshift(s),n.push(s),s=s.parent;if(s.type){for(t=0;t<n.length;t++)e=n[t],r(e,e.parent);f=s,r(s,s.parent),s==f&&(f=f.parent),o=o.concat(i)}},s.onText=function(e){var n=CKEDITOR.dtd[f.name];n&&!n["#"]||(i(),t(),e.replace(/(\r\n|[\r\n])|[^\r\n]*/g,function(e,t){if(void 0!==t&&t.length)h++;else if(e.length){var n=0;e.replace(c,function(t,i){r(new CKEDITOR.htmlParser.text(e.substring(n,i)),f),r(new CKEDITOR.htmlParser.element("smiley",{desc:u[t]}),f),n=i+t.length}),n!=e.length&&r(new CKEDITOR.htmlParser.text(e.substring(n,e.length)),f)}}))};for(s.parse(CKEDITOR.tools.htmlEncode(e));f.type!=CKEDITOR.NODE_DOCUMENT_FRAGMENT;)e=f.parent,r(f,e),f=e;return l};var d=new(CKEDITOR.tools.createClass({$:function(){this._={output:[],rules:[]},this.setRules("list",{breakBeforeOpen:1,breakAfterOpen:1,breakBeforeClose:1,breakAfterClose:1}),this.setRules("*",{breakBeforeOpen:1,breakAfterOpen:0,breakBeforeClose:1,breakAfterClose:0}),this.setRules("quote",{breakBeforeOpen:1,breakAfterOpen:0,breakBeforeClose:0,breakAfterClose:1})},proto:{setRules:function(e,t){var n=this._.rules[e];n?CKEDITOR.tools.extend(n,t,!0):this._.rules[e]=t},getRule:function(e,t){return this._.rules[e]&&this._.rules[e][t]},openTag:function(t){t in e&&(this.getRule(t,"breakBeforeOpen")&&this.lineBreak(1),this.write("[",t))},openTagClose:function(t){"br"==t?this._.output.push("\n"):t in e&&(this.write("]"),this.getRule(t,"breakAfterOpen")&&this.lineBreak(1))},attribute:function(e,t){"option"==e&&this.write("=",t)},closeTag:function(t){t in e&&(this.getRule(t,"breakBeforeClose")&&this.lineBreak(1),"*"!=t&&this.write("[/",t,"]"),this.getRule(t,"breakAfterClose")&&this.lineBreak(1))},text:function(e){this.write(e)},comment:function(){},lineBreak:function(){!this._.hasLineBreak&&this._.output.length&&(this.write("\n"),this._.hasLineBreak=1)},write:function(){this._.hasLineBreak=0,this._.output.push(Array.prototype.join.call(arguments,""))},reset:function(){this._.output=[],this._.hasLineBreak=0},getHtml:function(e){var t=this._.output.join("");return e&&this.reset(),f(t)}}}));CKEDITOR.plugins.add("bbcode",{requires:"entities",beforeInit:function(e){CKEDITOR.tools.extend(e.config,{enterMode:CKEDITOR.ENTER_BR,basicEntities:!1,entities:!1,fillEmptyBlocks:!1},!0),e.filter.disable(),e.activeEnterMode=e.enterMode=CKEDITOR.ENTER_BR},init:function(e){function n(e){var t=e.data,e=CKEDITOR.htmlParser.fragment.fromBBCode(e.data.dataValue),n=new CKEDITOR.htmlParser.basicWriter;e.writeHtml(n,r),e=n.getHtml(!0),t.dataValue=e}var i=e.config,r=new CKEDITOR.htmlParser.filter;r.addRules({elements:{blockquote:function(e){var t=new CKEDITOR.htmlParser.element("div");if(t.children=e.children,e.children=[t],t=e.attributes.cite){var n=new CKEDITOR.htmlParser.element("cite");n.add(new CKEDITOR.htmlParser.text(t.replace(/^"|"$/g,""))),delete e.attributes.cite,e.children.unshift(n)}},span:function(e){var t;(t=e.attributes.bbcode)&&("img"==t?(e.name="img",e.attributes.src=e.children[0].value,e.children=[]):"email"==t&&(e.name="a",e.attributes.href="mailto:"+e.children[0].value),delete e.attributes.bbcode)},ol:function(e){e.attributes.listType?"decimal"!=e.attributes.listType&&(e.attributes.style="list-style-type:"+e.attributes.listType):e.name="ul",delete e.attributes.listType},a:function(e){e.attributes.href||(e.attributes.href=e.children[0].value)},smiley:function(e){e.name="img";var t=e.attributes.desc,n=i.smiley_images[CKEDITOR.tools.indexOf(i.smiley_descriptions,t)],n=CKEDITOR.tools.htmlEncode(i.smiley_path+n);e.attributes={src:n,"data-cke-saved-src":n,title:t,alt:t}}}}),e.dataProcessor.htmlFilter.addRules({elements:{$:function(n){var i=n.attributes,r=CKEDITOR.tools.parseCssText(i.style,1),s,a=n.name;if(a in t)a=t[a];else if("span"==a)(s=r.color)?(a="color",s=CKEDITOR.tools.convertRgbToHex(s)):(s=r["font-size"])&&(i=s.match(/(\d+)%$/))&&(s=i[1],a="size");else if("ol"==a||"ul"==a){if(s=r["list-style-type"])switch(s){case"lower-alpha":s="a";break;case"upper-alpha":s="A"}else"ol"==a&&(s=1);a="list"}else if("blockquote"==a){try{var l=n.children[0],u=n.children[1],c="cite"==l.name&&l.children[0].value;c&&(s='"'+c+'"',n.children=u.children)}catch(e){}a="quote"}else if("a"==a)(s=i.href)&&(-1!==s.indexOf("mailto:")?(a="email",n.children=[new CKEDITOR.htmlParser.text(s.replace("mailto:",""))],s=""):((a=1==n.children.length&&n.children[0])&&a.type==CKEDITOR.NODE_TEXT&&a.value==s&&(s=""),a="url"));else if("img"==a){if(n.isEmpty=0,r=i["data-cke-saved-src"]||i.src,i=i.alt,r&&-1!=r.indexOf(e.config.smiley_path)&&i)return new CKEDITOR.htmlParser.text(o[i]);n.children=[new CKEDITOR.htmlParser.text(r)]}return n.name=a,s&&(n.attributes.option=s),null},br:function(e){if((e=e.next)&&e.name in a)return!1}}},1),e.dataProcessor.writer=d,e.elementMode==CKEDITOR.ELEMENT_MODE_INLINE?e.once("contentDom",function(){e.on("setData",n)}):e.on("setData",n)},afterInit:function(e){var t;e._.elementsPath&&(t=e._.elementsPath.filters)&&t.push(function(t){var i=t.getName(),r=n[i]||!1;return"link"==r&&0===t.getAttribute("href").indexOf("mailto:")?r="email":"span"==i?t.getStyle("font-size")?r="size":t.getStyle("color")&&(r="color"):"img"==r&&(t=t.data("cke-saved-src")||t.getAttribute("src"))&&0===t.indexOf(e.config.smiley_path)&&(r="smiley"),r})}})}();