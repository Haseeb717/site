/*
 Copyright (c) 2003-2015, CKSource - Frederico Knabben. All rights reserved.
 For licensing, see LICENSE.md or http://ckeditor.com/license
*/
CKEDITOR.dialog.add("image2",function(t){function e(){var t=this.getValue().match(s);return(t=!(!t||0===parseInt(t[1],10)))||alert(c["invalid"+CKEDITOR.tools.capitalize(this.id)]),t}function i(){function t(t,a){i.push(e.once(t,function(t){for(var e;e=i.pop();)e.removeListener();a(t)}))}var e=b.createElement("img"),i=[];return function(i,a,n){t("load",function(){var t=m(e);a.call(n,e,t.width,t.height)}),t("error",function(){a(null)}),t("abort",function(){a(null)}),e.setAttribute("src",(f.baseHref||"")+i+"?"+Math.random().toString(16).substring(2))}}function a(){var e=this.getValue();l(!1),e!==v.data.src?(V(e,function(e,i,a){if(l(!0),!e)return o(!1);E.setValue(!1===t.config.image2_prefillDimensions?0:i),T.setValue(!1===t.config.image2_prefillDimensions?0:a),k=i,D=a,o(p.checkHasNaturalRatio(e))}),x=!0):x?(l(!0),E.setValue(w),T.setValue(y),x=!1):l(!0)}function n(){if(I){var t=this.getValue();if(t&&(t.match(s)||o(!1),"0"!==t)){var e="width"==this.id,i=w||k,a=y||D,t=e?Math.round(a*(t/i)):Math.round(i*(t/a));isNaN(t)||(e?T:E).setValue(t)}}}function o(t){if(R){if("boolean"==typeof t){if(_)return;I=t}else t=E.getValue(),_=!0,(I=!I)&&t&&(t*=y/w,isNaN(t)||T.setValue(Math.round(t)));R[I?"removeClass":"addClass"]("cke_btn_unlocked"),R.setAttribute("aria-checked",I),CKEDITOR.env.hc&&R.getChild(0).setHtml(I?CKEDITOR.env.ie?"\u25a0":"\u25a3":CKEDITOR.env.ie?"\u25a1":"\u25a2")}}function l(t){t=t?"enable":"disable",E[t](),T[t]()}var s=/(^\s*(\d+)(px)?\s*$)|^$/i,u=CKEDITOR.tools.getNextId(),d=CKEDITOR.tools.getNextId(),r=t.lang.image2,c=t.lang.common,h=new CKEDITOR.template('<div><a href="javascript:void(0)" tabindex="-1" title="'+r.lockRatio+'" class="cke_btn_locked" id="{lockButtonId}" role="checkbox"><span class="cke_icon"></span><span class="cke_label">'+r.lockRatio+'</span></a><a href="javascript:void(0)" tabindex="-1" title="'+r.resetSize+'" class="cke_btn_reset" id="{resetButtonId}" role="button"><span class="cke_label">'+r.resetSize+"</span></a></div>").output({lockButtonId:u,resetButtonId:d}),p=CKEDITOR.plugins.image2,f=t.config,g=t.widgets.registered.image.features,m=p.getNatural,b,v,C,V,w,y,k,D,x,I,_,R,K,E,T,B,O=!(!f.filebrowserImageBrowseUrl&&!f.filebrowserBrowseUrl),N=[{id:"src",type:"text",label:c.url,onKeyup:a,onChange:a,setup:function(t){this.setValue(t.data.src)},commit:function(t){t.setData("src",this.getValue())},validate:CKEDITOR.dialog.validate.notEmpty(r.urlMissing)}];return O&&N.push({type:"button",id:"browse",style:"display:inline-block;margin-top:14px;",align:"center",label:t.lang.common.browseServer,hidden:!0,filebrowser:"info:src"}),{title:r.title,minWidth:250,minHeight:100,onLoad:function(){b=this._.element.getDocument(),V=i()},onShow:function(){v=this.widget,C=v.parts.image,x=_=I=!1,B=m(C),k=w=B.width,D=y=B.height},contents:[{id:"info",label:r.infoTab,elements:[{type:"vbox",padding:0,children:[{type:"hbox",widths:["100%"],children:N}]},{id:"alt",type:"text",label:r.alt,setup:function(t){this.setValue(t.data.alt)},commit:function(t){t.setData("alt",this.getValue())}},{type:"hbox",widths:["25%","25%","50%"],requiredContent:g.dimension.requiredContent,children:[{type:"text",width:"45px",id:"width",label:c.width,validate:e,onKeyUp:n,onLoad:function(){E=this},setup:function(t){this.setValue(t.data.width)},commit:function(t){t.setData("width",this.getValue())}},{type:"text",id:"height",width:"45px",label:c.height,validate:e,onKeyUp:n,onLoad:function(){T=this},setup:function(t){this.setValue(t.data.height)},commit:function(t){t.setData("height",this.getValue())}},{id:"lock",type:"html",style:"margin-top:18px;width:40px;height:20px;",onLoad:function(){function t(t){t.on("mouseover",function(){this.addClass("cke_btn_over")},t),t.on("mouseout",function(){this.removeClass("cke_btn_over")},t)}var e=this.getDialog();R=b.getById(u),K=b.getById(d),R&&(e.addFocusable(R,4+O),R.on("click",function(t){o(),t.data&&t.data.preventDefault()},this.getDialog()),t(R)),K&&(e.addFocusable(K,5+O),K.on("click",function(t){x?(E.setValue(k),T.setValue(D)):(E.setValue(w),T.setValue(y)),t.data&&t.data.preventDefault()},this),t(K))},setup:function(t){o(t.data.lock)},commit:function(t){t.setData("lock",I)},html:h}]},{type:"hbox",id:"alignment",requiredContent:g.align.requiredContent,children:[{id:"align",type:"radio",items:[[c.alignNone,"none"],[c.alignLeft,"left"],[c.alignCenter,"center"],[c.alignRight,"right"]],label:c.align,setup:function(t){this.setValue(t.data.align)},commit:function(t){t.setData("align",this.getValue())}}]},{id:"hasCaption",type:"checkbox",label:r.captioned,requiredContent:g.caption.requiredContent,setup:function(t){this.setValue(t.data.hasCaption)},commit:function(t){t.setData("hasCaption",this.getValue())}}]},{id:"Upload",hidden:!0,filebrowser:"uploadButton",label:r.uploadTab,elements:[{type:"file",id:"upload",label:r.btnUpload,style:"height:40px"},{type:"fileButton",id:"uploadButton",filebrowser:"info:src",label:r.btnUpload,"for":["Upload","upload"]}]}]}});