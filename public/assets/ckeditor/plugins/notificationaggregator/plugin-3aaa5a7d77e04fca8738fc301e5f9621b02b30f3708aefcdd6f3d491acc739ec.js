/*
 Copyright (c) 2003-2015, CKSource - Frederico Knabben. All rights reserved.
 For licensing, see LICENSE.md or http://ckeditor.com/license
*/
!function(){function t(t,i,e){this.editor=t,this.notification=null,this._message=new CKEDITOR.template(i),this._singularMessage=e?new CKEDITOR.template(e):null,this._tasks=[],this._doneTasks=this._doneWeights=this._totalWeights=0}function i(t){this._weight=t||1,this._doneWeight=0,this._isCanceled=!1}CKEDITOR.plugins.add("notificationaggregator",{requires:"notification"}),t.prototype={createTask:function(t){var t=t||{},i=!this.notification,e;return i&&(this.notification=this._createNotification()),e=this._addTask(t),e.on("updated",this._onTaskUpdate,this),e.on("done",this._onTaskDone,this),e.on("canceled",function(){this._removeTask(e)},this),this.update(),i&&this.notification.show(),e},update:function(){this._updateNotification(),this.isFinished()&&this.fire("finished")},getPercentage:function(){return 0===this.getTaskCount()?1:this._doneWeights/this._totalWeights},isFinished:function(){return this.getDoneTaskCount()===this.getTaskCount()},getTaskCount:function(){return this._tasks.length},getDoneTaskCount:function(){return this._doneTasks},_updateNotification:function(){this.notification.update({message:this._getNotificationMessage(),progress:this.getPercentage()})},_getNotificationMessage:function(){var t=this.getTaskCount(),i={current:this.getDoneTaskCount(),max:t,percentage:Math.round(100*this.getPercentage())};return(1==t&&this._singularMessage?this._singularMessage:this._message).output(i)},_createNotification:function(){return new CKEDITOR.plugins.notification(this.editor,{type:"progress"})},_addTask:function(t){return t=new i(t.weight),this._tasks.push(t),this._totalWeights+=t._weight,t},_removeTask:function(t){var i=CKEDITOR.tools.indexOf(this._tasks,t);-1!==i&&(t._doneWeight&&(this._doneWeights-=t._doneWeight),this._totalWeights-=t._weight,this._tasks.splice(i,1),this.update())},_onTaskUpdate:function(t){this._doneWeights+=t.data,this.update()},_onTaskDone:function(){this._doneTasks+=1,this.update()}},CKEDITOR.event.implementOn(t.prototype),i.prototype={done:function(){this.update(this._weight)},update:function(t){if(!this.isDone()&&!this.isCanceled()){var t=Math.min(this._weight,t),i=t-this._doneWeight;this._doneWeight=t,this.fire("updated",i),this.isDone()&&this.fire("done")}},cancel:function(){!this.isDone()&&!this.isCanceled()&&(this._isCanceled=!0,this.fire("canceled"))},isDone:function(){return this._weight===this._doneWeight},isCanceled:function(){return this._isCanceled}},CKEDITOR.event.implementOn(i.prototype),CKEDITOR.plugins.notificationAggregator=t,CKEDITOR.plugins.notificationAggregator.task=i}();