/*
 Copyright (c) 2003-2015, CKSource - Frederico Knabben. All rights reserved.
 For licensing, see LICENSE.md or http://ckeditor.com/license
*/
!function(){CKEDITOR.plugins.add("uploadwidget",{lang:"cs,da,de,en,eo,fr,gl,hu,it,ko,nb,nl,pl,pt-br,ru,sv,tr,zh,zh-cn",requires:"widget,clipboard,filetools,notificationaggregator",init:function(e){e.filter.allow("*[!data-widget,!data-cke-upload-id]")}}),CKEDITOR.fileTools||(CKEDITOR.fileTools={}),CKEDITOR.tools.extend(CKEDITOR.fileTools,{addUploadWidget:function(e,t,a){var o=CKEDITOR.fileTools,i=e.uploadRepository,n=a.supportedTypes?10:20;a.fileToElement&&e.on("paste",function(n){var n=n.data,d=n.dataTransfer,l=d.getFilesCount(),r=a.loadMethod||"loadAndUpload",s,p;if(!n.dataValue&&l)for(p=0;p<l;p++)if(s=d.getFile(p),!a.supportedTypes||o.isTypeSupported(s,a.supportedTypes)){var u=a.fileToElement(s);s=i.create(s),u&&(s[r](a.uploadUrl),CKEDITOR.fileTools.markElement(u,t,s.id),("loadAndUpload"==r||"upload"==r)&&CKEDITOR.fileTools.bindNotifications(e,s),n.dataValue=n.dataValue+u.getOuterHtml())}},null,null,n),CKEDITOR.tools.extend(a,{downcast:function(){return new CKEDITOR.htmlParser.text("")},init:function(){var t=this,a=this.wrapper.findOne("[data-cke-upload-id]").data("cke-upload-id"),o=i.loaders[a],n=CKEDITOR.tools.capitalize,d,l;o.on("update",function(i){t.wrapper&&t.wrapper.getParent()?(e.fire("lockSnapshot"),i="on"+n(o.status),"function"==typeof t[i]&&!1===t[i](o)||(l="cke_upload_"+o.status,t.wrapper&&l!=d&&(d&&t.wrapper.removeClass(d),t.wrapper.addClass(l),d=l),("error"==o.status||"abort"==o.status)&&e.widgets.del(t)),e.fire("unlockSnapshot")):(e.editable().find('[data-cke-upload-id="'+a+'"]').count()||o.abort(),i.removeListener())}),o.update()},replaceWith:function(t,a){if(""===t.trim())e.widgets.del(this);else{var o=this==e.widgets.focused,i=e.editable(),n=e.createRange(),d,l;o||(l=e.getSelection().createBookmarks()),n.setStartBefore(this.wrapper),n.setEndAfter(this.wrapper),o&&(d=n.createBookmark()),i.insertHtmlIntoRange(t,n,a),e.widgets.checkWidgets({initOnlyNew:!0}),e.widgets.destroy(this,!0),o?(n.moveToBookmark(d),n.select()):e.getSelection().selectBookmarks(l)}}}),e.widgets.add(t,a)},markElement:function(e,t,a){e.setAttributes({"data-cke-upload-id":a,"data-widget":t})},bindNotifications:function(e,t){var a=e._.uploadWidgetNotificaionAggregator;a&&!a.isFinished()||(a=e._.uploadWidgetNotificaionAggregator=new CKEDITOR.plugins.notificationAggregator(e,e.lang.uploadwidget.uploadMany,e.lang.uploadwidget.uploadOne),a.once("finished",function(){var t=a.getTaskCount();0===t?a.notification.hide():a.notification.update({message:1==t?e.lang.uploadwidget.doneOne:e.lang.uploadwidget.doneMany.replace("%1",t),type:"success",important:1})}));var o=a.createTask({weight:t.total});t.on("update",function(){o&&"uploading"==t.status&&o.update(t.uploaded)}),t.on("uploaded",function(){o&&o.done()}),t.on("error",function(){o&&o.cancel(),e.showNotification(t.message,"warning")}),t.on("abort",function(){o&&o.cancel(),e.showNotification(e.lang.uploadwidget.abort,"info")})}})}();